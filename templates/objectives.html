<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Learning Objectives - Canvas Quiz Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .sticky-header {
            position: sticky;
            top: 0;
            z-index: 1000;
            background-color: white;
            border-bottom: 1px solid #dee2e6;
            padding: 1rem 0;
            margin-bottom: 1rem;
        }
        .objective-item {
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            margin-bottom: 1rem;
            background-color: #f8f9fa;
            transition: transform 0.2s;
        }
        .objective-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .objective-number {
            background-color: #0d6efd;
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            flex-shrink: 0;
        }
        .auto-save-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
        }
        .drag-handle {
            cursor: grab;
        }
        .drag-handle:active {
            cursor: grabbing;
        }
        .objective-input {
            border: none;
            background: transparent;
            resize: none;
            min-height: 40px;
        }
        .objective-input:focus {
            border: 1px solid #0d6efd;
            background: white;
            border-radius: 0.375rem;
            padding: 0.375rem;
        }
    </style>
</head>
<body>
    <!-- Auto-save indicator -->
    <div id="autoSaveIndicator" class="auto-save-indicator" style="display: none;">
        <div class="alert alert-success alert-sm mb-0">
            <i class="fas fa-check"></i> Saved
        </div>
    </div>

    <!-- Sticky Header -->
    <div class="sticky-header">
        <div class="container-fluid">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-0">
                        <i class="fas fa-bullseye text-warning"></i> Learning Objectives
                        <small class="text-muted">- Course Goals & Outcomes</small>
                    </h1>
                </div>
                <div>
                    <button id="addObjectiveBtn" class="btn btn-success me-2">
                        <i class="fas fa-plus"></i> Add Objective
                    </button>
                    <button id="saveAllBtn" class="btn btn-primary me-2">
                        <i class="fas fa-save"></i> Save All
                    </button>
                    <a href="/" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left"></i> Back to Questions
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid">
        <!-- Alert container -->
        <div id="alertContainer"></div>

        <!-- Instructions -->
        <div class="alert alert-info mb-4">
            <h6 class="alert-heading">
                <i class="fas fa-info-circle"></i> About Learning Objectives
            </h6>
            <p class="mb-2">Learning objectives define what students should be able to do after completing the course material. They help:</p>
            <ul class="mb-2">
                <li>Guide the development of quiz questions and assessments</li>
                <li>Ensure alignment between course content and evaluation methods</li>
                <li>Provide clear expectations for student learning outcomes</li>
                <li>Support accessibility by establishing measurable goals</li>
            </ul>
            <small class="text-muted">
                <strong>Tips:</strong> Use action verbs (analyze, evaluate, create) and be specific and measurable.
                Objectives are automatically saved as you type.
            </small>
        </div>

        <!-- Learning Objectives List -->
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-list"></i> Course Learning Objectives
                        <span class="badge bg-secondary ms-2" id="objectiveCount">{{ objectives|length if objectives else 0 }}</span>
                    </h5>
                    <div>
                        <small class="text-muted">
                            <i class="fas fa-arrows-alt"></i> Drag to reorder • 
                            <i class="fas fa-edit"></i> Click to edit • 
                            <i class="fas fa-save"></i> Auto-save enabled
                        </small>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div id="objectivesList">
                    {% if objectives and objectives|length > 0 %}
                        {% for objective in objectives %}
                        <div class="objective-item" data-objective-id="{{ loop.index0 }}">
                            <div class="d-flex align-items-start p-3">
                                <div class="drag-handle me-3 mt-1">
                                    <i class="fas fa-grip-vertical text-muted"></i>
                                </div>
                                <div class="objective-number me-3 mt-1">
                                    {{ loop.index }}
                                </div>
                                <div class="flex-grow-1">
                                    <textarea class="objective-input form-control" 
                                              placeholder="Enter learning objective here..."
                                              data-objective-index="{{ loop.index0 }}">{{ objective.text }}</textarea>
                                    <div class="row mt-2">
                                        <div class="col-md-6">
                                            <small class="text-muted">
                                                <strong>Bloom's Level:</strong>
                                                <select class="form-select form-select-sm blooms-level" data-objective-index="{{ loop.index0 }}">
                                                    <option value="remember" {% if objective.blooms_level == 'remember' %}selected{% endif %}>Remember</option>
                                                    <option value="understand" {% if objective.blooms_level == 'understand' %}selected{% endif %}>Understand</option>
                                                    <option value="apply" {% if objective.blooms_level == 'apply' %}selected{% endif %}>Apply</option>
                                                    <option value="analyze" {% if objective.blooms_level == 'analyze' %}selected{% endif %}>Analyze</option>
                                                    <option value="evaluate" {% if objective.blooms_level == 'evaluate' %}selected{% endif %}>Evaluate</option>
                                                    <option value="create" {% if objective.blooms_level == 'create' %}selected{% endif %}>Create</option>
                                                </select>
                                            </small>
                                        </div>
                                        <div class="col-md-6">
                                            <small class="text-muted">
                                                <strong>Priority:</strong>
                                                <select class="form-select form-select-sm priority-level" data-objective-index="{{ loop.index0 }}">
                                                    <option value="high" {% if objective.priority == 'high' %}selected{% endif %}>High</option>
                                                    <option value="medium" {% if objective.priority == 'medium' %}selected{% endif %}>Medium</option>
                                                    <option value="low" {% if objective.priority == 'low' %}selected{% endif %}>Low</option>
                                                </select>
                                            </small>
                                        </div>
                                    </div>
                                </div>
                                <div class="ms-3">
                                    <button class="btn btn-sm btn-outline-danger delete-objective" 
                                            data-objective-index="{{ loop.index0 }}"
                                            title="Delete objective">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                    <div class="text-center py-5" id="emptyState">
                        <i class="fas fa-bullseye fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No Learning Objectives Yet</h5>
                        <p class="text-muted">Click "Add Objective" to create your first learning objective.</p>
                        <button class="btn btn-primary" onclick="addNewObjective()">
                            <i class="fas fa-plus"></i> Add Your First Objective
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Bloom's Taxonomy Reference -->
        <div class="card mt-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-graduation-cap"></i> Bloom's Taxonomy Reference
                </h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-2">
                        <strong class="text-primary">Remember</strong><br>
                        <small>Recall facts, terms, concepts</small>
                    </div>
                    <div class="col-md-2">
                        <strong class="text-info">Understand</strong><br>
                        <small>Explain ideas, concepts</small>
                    </div>
                    <div class="col-md-2">
                        <strong class="text-success">Apply</strong><br>
                        <small>Use knowledge in new situations</small>
                    </div>
                    <div class="col-md-2">
                        <strong class="text-warning">Analyze</strong><br>
                        <small>Break down, examine parts</small>
                    </div>
                    <div class="col-md-2">
                        <strong class="text-danger">Evaluate</strong><br>
                        <small>Judge, critique, assess</small>
                    </div>
                    <div class="col-md-2">
                        <strong class="text-dark">Create</strong><br>
                        <small>Build, design, compose</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let objectives = {{ objectives | tojson if objectives else '[]' }};
        let saveTimeout;
        
        // DOM elements
        const objectivesList = document.getElementById('objectivesList');
        const objectiveCount = document.getElementById('objectiveCount');
        const emptyState = document.getElementById('emptyState');
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            updateObjectiveNumbers();
            addEventListeners();
        });
        
        // Add event listeners
        function addEventListeners() {
            // Add objective button
            document.getElementById('addObjectiveBtn').addEventListener('click', addNewObjective);
            
            // Save all button
            document.getElementById('saveAllBtn').addEventListener('click', saveAllObjectives);
            
            // Event delegation for dynamic elements
            document.addEventListener('click', handleDynamicClicks);
            document.addEventListener('input', handleDynamicInput);
            document.addEventListener('change', handleDynamicChange);
        }
        
        // Handle dynamic clicks
        function handleDynamicClicks(e) {
            if (e.target.closest('.delete-objective')) {
                const index = parseInt(e.target.closest('.delete-objective').dataset.objectiveIndex);
                deleteObjective(index);
            }
        }
        
        // Handle dynamic input
        function handleDynamicInput(e) {
            if (e.target.classList.contains('objective-input')) {
                scheduleAutoSave();
            }
        }
        
        // Handle dynamic changes
        function handleDynamicChange(e) {
            if (e.target.classList.contains('blooms-level') || e.target.classList.contains('priority-level')) {
                scheduleAutoSave();
            }
        }
        
        // Add new objective
        function addNewObjective() {
            const newObjective = {
                text: '',
                blooms_level: 'understand',
                priority: 'medium'
            };
            
            objectives.push(newObjective);
            renderObjectives();
            updateObjectiveCount();
            
            // Focus on the new objective input
            const newInputs = document.querySelectorAll('.objective-input');
            if (newInputs.length > 0) {
                newInputs[newInputs.length - 1].focus();
            }
            
            scheduleAutoSave();
        }
        
        // Delete objective
        function deleteObjective(index) {
            if (confirm('Are you sure you want to delete this learning objective?')) {
                objectives.splice(index, 1);
                renderObjectives();
                updateObjectiveCount();
                scheduleAutoSave();
            }
        }
        
        // Render objectives
        function renderObjectives() {
            if (objectives.length === 0) {
                showEmptyState();
                return;
            }
            
            hideEmptyState();
            
            const html = objectives.map((objective, index) => `
                <div class="objective-item" data-objective-id="${index}">
                    <div class="d-flex align-items-start p-3">
                        <div class="drag-handle me-3 mt-1">
                            <i class="fas fa-grip-vertical text-muted"></i>
                        </div>
                        <div class="objective-number me-3 mt-1">
                            ${index + 1}
                        </div>
                        <div class="flex-grow-1">
                            <textarea class="objective-input form-control" 
                                      placeholder="Enter learning objective here..."
                                      data-objective-index="${index}">${objective.text || ''}</textarea>
                            <div class="row mt-2">
                                <div class="col-md-6">
                                    <small class="text-muted">
                                        <strong>Bloom's Level:</strong>
                                        <select class="form-select form-select-sm blooms-level" data-objective-index="${index}">
                                            <option value="remember" ${objective.blooms_level === 'remember' ? 'selected' : ''}>Remember</option>
                                            <option value="understand" ${objective.blooms_level === 'understand' ? 'selected' : ''}>Understand</option>
                                            <option value="apply" ${objective.blooms_level === 'apply' ? 'selected' : ''}>Apply</option>
                                            <option value="analyze" ${objective.blooms_level === 'analyze' ? 'selected' : ''}>Analyze</option>
                                            <option value="evaluate" ${objective.blooms_level === 'evaluate' ? 'selected' : ''}>Evaluate</option>
                                            <option value="create" ${objective.blooms_level === 'create' ? 'selected' : ''}>Create</option>
                                        </select>
                                    </small>
                                </div>
                                <div class="col-md-6">
                                    <small class="text-muted">
                                        <strong>Priority:</strong>
                                        <select class="form-select form-select-sm priority-level" data-objective-index="${index}">
                                            <option value="high" ${objective.priority === 'high' ? 'selected' : ''}>High</option>
                                            <option value="medium" ${objective.priority === 'medium' ? 'selected' : ''}>Medium</option>
                                            <option value="low" ${objective.priority === 'low' ? 'selected' : ''}>Low</option>
                                        </select>
                                    </small>
                                </div>
                            </div>
                        </div>
                        <div class="ms-3">
                            <button class="btn btn-sm btn-outline-danger delete-objective" 
                                    data-objective-index="${index}"
                                    title="Delete objective">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
            
            objectivesList.innerHTML = html;
        }
        
        // Show/hide empty state
        function showEmptyState() {
            if (emptyState) {
                emptyState.style.display = 'block';
            }
        }
        
        function hideEmptyState() {
            if (emptyState) {
                emptyState.style.display = 'none';
            }
        }
        
        // Update objective numbers and count
        function updateObjectiveNumbers() {
            const numbers = document.querySelectorAll('.objective-number');
            numbers.forEach((num, index) => {
                num.textContent = index + 1;
            });
        }
        
        function updateObjectiveCount() {
            if (objectiveCount) {
                objectiveCount.textContent = objectives.length;
            }
        }
        
        // Collect form data
        function collectObjectivesData() {
            const inputs = document.querySelectorAll('.objective-input');
            const bloomsSelects = document.querySelectorAll('.blooms-level');
            const prioritySelects = document.querySelectorAll('.priority-level');
            
            objectives = [];
            
            inputs.forEach((input, index) => {
                const blooms = bloomsSelects[index]?.value || 'understand';
                const priority = prioritySelects[index]?.value || 'medium';
                
                objectives.push({
                    text: input.value.trim(),
                    blooms_level: blooms,
                    priority: priority
                });
            });
            
            return objectives.filter(obj => obj.text.length > 0);
        }
        
        // Schedule auto-save
        function scheduleAutoSave() {
            if (saveTimeout) {
                clearTimeout(saveTimeout);
            }
            saveTimeout = setTimeout(autoSave, 2000); // Save after 2 seconds of inactivity
        }
        
        // Auto-save function
        async function autoSave() {
            await saveAllObjectives(true);
        }
        
        // Save all objectives
        async function saveAllObjectives(isAutoSave = false) {
            const saveBtn = document.getElementById('saveAllBtn');
            const originalText = saveBtn?.innerHTML;
            
            try {
                if (!isAutoSave && saveBtn) {
                    saveBtn.disabled = true;
                    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
                }
                
                const objectivesData = collectObjectivesData();
                
                const response = await fetch('/objectives', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({objectives: objectivesData})
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    if (isAutoSave) {
                        showAutoSaveIndicator();
                    } else {
                        showAlert('success', result.message || 'Learning objectives saved successfully!');
                    }
                    objectives = objectivesData;
                    updateObjectiveCount();
                } else {
                    if (!isAutoSave) {
                        showAlert('danger', result.detail || 'Failed to save learning objectives');
                    }
                }
            } catch (error) {
                if (!isAutoSave) {
                    showAlert('danger', 'Error saving objectives: ' + error.message);
                }
                console.error('Save error:', error);
            } finally {
                if (!isAutoSave && saveBtn) {
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = originalText;
                }
            }
        }
        
        // Show auto-save indicator
        function showAutoSaveIndicator() {
            const indicator = document.getElementById('autoSaveIndicator');
            if (indicator) {
                indicator.style.display = 'block';
                setTimeout(() => {
                    indicator.style.display = 'none';
                }, 2000);
            }
        }
        
        // Show alert function
        function showAlert(type, message) {
            const alertContainer = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-dismissible fade show`;
            alert.innerHTML = `
                ${message}
                <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"alert\"></button>
            `;
            alertContainer.appendChild(alert);
            
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.remove();
                }
            }, 5000);
        }
    </script>
</body>
</html>