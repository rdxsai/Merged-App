<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Socratic Tutor - Canvas Quiz Manager</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
  <style>
    body {
      background-color: #f8f9fa;
    }

    .sticky-header {
      position: sticky;
      top: 0;
      z-index: 1000;
      background-color: white;
      border-bottom: 1px solid #dee2e6;
      padding: 1rem 0;
      margin-bottom: 1rem;
    }

    .chat-container {
      height: calc(100vh - 150px);
      display: flex;
      flex-direction: column;
      background-color: #ffffff;
      border: 1px solid #dee2e6;
      border-radius: 8px;
    }

    .chat-messages {
      flex-grow: 1;
      overflow-y: auto;
      padding: 1rem;
    }

    .chat-input-area {
      border-top: 1px solid #dee2e6;
      padding: 0.75rem;
      background-color: #f8f9fa;
    }

    .chat-input-area textarea {
      resize: none;
      max-height: 10rem;
    }

    .message-bubble {
      display: flex;
      align-items: flex-start;
      margin-bottom: 1.25rem;
      max-width: 85%;
    }

    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      color: white;
      flex-shrink: 0;
    }

    .avatar-tutor {
      background-color: #0d6efd;
    }

    .avatar-user {
      background-color: #6c757d;
    }

    .message-content {
      padding: 0.75rem 1rem;
      border-radius: 12px;
      position: relative;
    }

    .message-bubble.tutor {
      margin-right: auto;
    }

    .message-bubble.tutor .message-content {
      background-color: #e9ecef;
      color: #212529;
      margin-left: 0.75rem;
      border-bottom-left-radius: 0;
    }

    .message-bubble.user {
      margin-left: auto;
      flex-direction: row-reverse;
    }

    .message-bubble.user .message-content {
      background-color: #0d6efd;
      color: white;
      margin-right: 0.75rem;
      border-bottom-right-radius: 0;
    }

    .message-timestamp {
      font-size: 0.75rem;
      color: #6c757d;
      margin-top: 0.25rem;
    }

    .message-bubble.user .message-timestamp {
      text-align: right;
    }

    .typing-indicator {
      display: none;
      align-items: flex-start;
    }

    .typing-dots {
      display: inline-block;
      padding: 1.25rem;
    }

    .typing-dots span {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background-color: #6c757d;
      margin: 0 2px;
      animation: typing 1.4s infinite ease-in-out;
    }

    .typing-dots span:nth-child(1) {
      animation-delay: -0.32s;
    }

    .typing-dots span:nth-child(2) {
      animation-delay: -0.16s;
    }

    @keyframes typing {

      0%,
      80%,
      100% {
        transform: scale(0.8);
        opacity: 0.5;
      }

      40% {
        transform: scale(1);
        opacity: 1;
      }
    }

    .progress-panel {
      height: calc(100vh - 150px);
      border: 1px solid #dee2e6;
      border-radius: 8px;
      background-color: #ffffff;
    }

    .progress-header {
      padding: 1rem;
      border-bottom: 1px solid #dee2e6;
    }

    .progress-content {
      height: calc(100% - 60px);
      overflow-y: auto;
      padding: 1rem;
    }

    .progress-item {
      margin-bottom: 1rem;
    }

    .progress-item strong {
      display: block;
      color: #495057;
    }

    .progress-item span,
    .progress-item .progress {
      font-size: 0.9rem;
    }
  </style>
</head>

<body>
  <!-- Sticky Header -->
  <div class="sticky-header">
    <div class="container-fluid">
      <div class="d-flex justify-content-between align-items-center">
        <h1 class="h3 mb-0">
          <i class="fas fa-comments text-primary"></i> Socratic Tutor
        </h1>
        <div>
          <button id="newConversationBtn" class="btn btn-outline-danger me-2">
            <i class="fas fa-sync-alt"></i> New Conversation
          </button>
          <a href="/" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> Back to Questions
          </a>
        </div>
      </div>
    </div>
  </div>

  <div class="container-fluid">
    <div id="alertContainer"></div>
    <div class="row">
      <!-- Chat Panel (Left) -->
      <div class="col-lg-8 mb-3 mb-lg-0">
        <div class="chat-container">
          <div class="chat-messages" id="chatMessages">
            <div class="message-bubble tutor typing-indicator" id="typingIndicator">
              <div class="avatar avatar-tutor">
                <i class="fas fa-robot"></i>
              </div>
              <div class="message-content">
                <div class="typing-dots">
                  <span></span>
                  <span></span>
                  <span></span>
                </div>
              </div>
            </div>
          </div>
          <div class="chat-input-area">
            <div class="d-flex">
              <textarea id="messageInput" class="form-control me-2" placeholder="Type your message..."
                rows="1"></textarea>
              <button id="sendBtn" class="btn btn-primary send-btn">
                <i class="fas fa-paper-plane"></i>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Student Progress Panel (Right) -->
      <div class="col-lg-4">
        <div class="d-lg-none mb-2">
          <button class="btn btn-outline-secondary w-100" type="button" data-bs-toggle="collapse"
            data-bs-target="#progressCollapse" aria-expanded="false" aria-controls="progressCollapse">
            <i class="fas fa-tasks"></i> Toggle Student Progress
          </button>
        </div>
        <div class="collapse d-lg-block" id="progressCollapse">
          <div class="progress-panel">
            <div class="progress-header">
              <h6 class="mb-0">
                <i class="fas fa-user-graduate"></i> Student Progress
              </h6>
            </div>
            <div class="progress-content" id="progressContent">
              <div class="progress-item">
                <strong>Student ID:</strong>
                <span id="studentIdDisplay" class="text-muted">Initializing...</span>
              </div>
              <div class="progress-item">
                <strong>Current Topic:</strong>
                <span id="currentTopic" class="text-muted">None</span>
              </div>
              <div class="progress-item">
                <strong>Knowledge Level:</strong>
                <span id="knowledgeLevel" class="badge bg-light text-dark">Unknown</span>
              </div>
              <div class="progress-item">
                <strong>Session Phase:</strong>
                <span id="sessionPhase" class="badge bg-light text-dark">Not Started</span>
              </div>
              <div class="progress-item">
                <strong>Misconceptions:</strong>
                <ul id="misconceptionsList" class="list-unstyled text-muted ps-3">
                  <li>None identified.</li>
                </ul>
              </div>
              <div class="progress-item">
                <strong>Progress (temp):</strong>
                <div class="progress" style="height: 10px;">
                  <div id="understandingProgress" class="progress-bar" role="progressbar" style="width: 0%;"
                    aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const messageInput = document.getElementById("messageInput");
      const sendBtn = document.getElementById("sendBtn");
      const chatMessages = document.getElementById("chatMessages");
      const typingIndicator = document.getElementById("typingIndicator");
      const newConversationBtn = document.getElementById("newConversationBtn");
      const studentIdDisplay = document.getElementById("studentIdDisplay");
      const currentTopic = document.getElementById("currentTopic");
      const knowledgeLevel = document.getElementById("knowledgeLevel");
      const sessionPhase = document.getElementById("sessionPhase");
      const misconceptionsList = document.getElementById("misconceptionsList");
      const understandingProgress = document.getElementById("understandingProgress");

      let isProcessing = false;
      // --- THIS IS THE FIX ---
      // We will get the student ID from the API response
      // and store it here.
      let studentId = null;
      // --- END OF FIX ---

      function startNewConversation() {
        // We no longer create a UUID here. We let the backend do it.
        studentId = null;
        studentIdDisplay.textContent = "Initializing...";
        chatMessages.innerHTML = "";
        chatMessages.appendChild(typingIndicator);
        updateProgressPanel(null);

        // Send a "START_SESSION" message.
        // The new chat.py will see student_id is null and create one.
        sendMessage("START_SESSION");
      }

      newConversationBtn.addEventListener("click", startNewConversation);

      sendBtn.addEventListener("click", () => {
        const message = messageInput.value.trim();
        if (message) {
          sendMessage(message);
          messageInput.value = "";
          autoResizeTextarea(messageInput);
        }
      });

      messageInput.addEventListener("keypress", function (e) {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendBtn.click();
        }
      });

      messageInput.addEventListener("input", () => autoResizeTextarea(messageInput));

      async function sendMessage(message) {
        if (isProcessing && message !== "START_SESSION") return;

        if (message !== "START_SESSION") {
          addMessage("user", message);
        }

        setProcessingState(true);

        try {
          const response = await fetch("/chat/message", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              message: message,
              student_id: studentId // This will be `null` for the first message
            }),
          });

          const result = await response.json();

          if (response.ok) {
            // --- THIS IS THE FIX ---
            // The server sends back the ID, so we save it
            // for all future messages in this session.
            studentId = result.student_id;
            // --- END OF FIX ---

            addMessage("tutor", result.response);
            updateProgressPanel(result.session_metadata);
          } else {
            throw new Error(result.detail || "An unknown error occurred.");
          }

        } catch (error) {
          addMessage("system", `Error: ${error.message}`);
        } finally {
          setProcessingState(false);
        }
      }

      function addMessage(type, content) {
        const messageBubble = document.createElement("div");
        messageBubble.className = `message-bubble ${type}`;
        const avatar = document.createElement("div");
        avatar.className = `avatar avatar-${type}`;
        avatar.innerHTML = `<i class="fas ${type === 'user' ? 'fa-user' : 'fa-robot'}"></i>`;
        const messageContent = document.createElement("div");
        messageContent.className = "message-content";
        const messageText = document.createElement("div");
        messageText.innerHTML = formatMessage(content);
        const timestamp = document.createElement("div");
        timestamp.className = "message-timestamp";
        timestamp.textContent = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
        messageContent.appendChild(messageText);
        messageContent.appendChild(timestamp);
        messageBubble.appendChild(avatar);
        messageBubble.appendChild(messageContent);
        chatMessages.insertBefore(messageBubble, typingIndicator);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      function updateProgressPanel(metadata) {
        // --- THIS IS THE FIX ---
        // Update the display with the new studentId
        studentIdDisplay.textContent = studentId ? studentId.split('-')[0] + "..." : "N/A";
        // --- END OF FIX ---

        if (!metadata || !metadata.analysis) { // Check for metadata.analysis
          currentTopic.textContent = "Web Accessibility";
          knowledgeLevel.textContent = "Unknown";
          sessionPhase.textContent = "Not Started";
          misconceptionsList.innerHTML = "<li>None identified.</li>";
          understandingProgress.style.width = "0%";
          understandingProgress.textContent = "0%";
          return;
        }

        const analysis = metadata.analysis;

        currentTopic.textContent = "Web Accessibility"; // Hardcoded for now
        knowledgeLevel.textContent = analysis.understanding_level || "Unknown";
        sessionPhase.textContent = metadata.session_phase || "Unknown";

        let knowledgeClass = "bg-light text-dark";
        if (analysis.understanding_level === "recall") knowledgeClass = "bg-danger";
        if (analysis.understanding_level === "understanding") knowledgeClass = "bg-warning";
        if (analysis.understanding_level === "application") knowledgeClass = "bg-info";
        if (analysis.understanding_level === "analysis") knowledgeClass = "bg-success";
        knowledgeLevel.className = `badge ${knowledgeClass}`;

        if (analysis.misconceptions && analysis.misconceptions.length > 0) {
          misconceptionsList.innerHTML = "";
          analysis.misconceptions.forEach(misconception => {
            const li = document.createElement("li");
            li.innerHTML = `<i class="fas fa-times-circle text-danger me-2"></i>${escapeHtml(misconception)}`;
            misconceptionsList.appendChild(li);
          });
        } else {
          misconceptionsList.innerHTML = "<li>None identified.</li>";
        }

        // This is just a placeholder, as 'understanding_progression' is a list
        let progress = (metadata.session_number || 1) * 10;
        understandingProgress.style.width = `${progress}%`;
        understandingProgress.textContent = `${progress}%`;
      }

      function setProcessingState(processing) {
        isProcessing = processing;
        sendBtn.disabled = processing;
        messageInput.disabled = processing;
        typingIndicator.style.display = processing ? "flex" : "none";

        if (processing) {
          sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
          chatMessages.scrollTop = chatMessages.scrollHeight;
        } else {
          sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
          messageInput.focus();
        }
      }

      function autoResizeTextarea(textarea) {
        textarea.style.height = 'auto';
        textarea.style.height = `${Math.min(textarea.scrollHeight, 160)}px`;
      }

      function formatMessage(content) {
        return escapeHtml(content)
          .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>")
          .replace(/\*(.*?)\*/g, "<em>$1</em>")
          .replace(/\n/g, "<br>");
      }

      function escapeHtml(text) {
        if (typeof text !== 'string') return '';
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      startNewConversation();
    });
  </script>
</body>

</html>